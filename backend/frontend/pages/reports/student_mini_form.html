<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Mini Reports</title>

<link href="{{ url_for('static', path='/css/reports/income_report.css') }}" rel="stylesheet">

</head>
<body>
  <div class="form-container">

    <div id="header"> 
    <h1>Student Mini Report</h1>
    </div>


    <form id="reportForm" action="/reports/student_mini_report" method="POST">
      <section>
            <h3>Report Information</h3>
            <div id="second-row">
                <div class="form-row">
                    <label>Student ID:</label>
                    <input type="number" name="student_id" id="student_id" required>
                </div>
            </div>

    <div class="submit-container">
        <button type="submit">Generate Report</button>
        <button type="button" onclick="window.location.href='/main/list_form'">Close</button>
    </div>
    
    </form>
    </div>

    <script>
    document.getElementById("reportForm").addEventListener("submit", async function (e) {
        e.preventDefault(); // Stop standard submission
        clearValidation();  // Use sample's clear function

        const studentIdInput = document.querySelector("input[name='student_id']");
        const studentId = studentIdInput.value.trim();
        let isValid = true;

        // ===== 1️⃣ Validation: Check if Empty (Using Sample Style) =====
        if (studentId === "") {
            showFieldError(studentIdInput, "Student ID is required");
            isValid = false;
        }

        if (!isValid) return; // Stop if empty

        // ===== 2️⃣ Validation: Check if Student Exists (Async) =====
        try {
            const response = await fetch("/student/check_student", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ student_id: studentId })
            });

            const result = await response.json();

            if (!result.exists) {
                // Using the Sample's error style
                showFieldError(studentIdInput, "Student not found. Please add student first.");
                return;
            }

            // ===== 3️⃣ SUCCESS: Redirect =====
            // Since validation passed, we manually redirect to the GET route
            window.location.href = `/reports/student_mini_report/${studentId}`;

        } catch (err) {
            console.error(err);
            alert("Server error. Try again.");
        }
    });

    // ==========================================
    //  HELPER FUNCTIONS (From your Sample)
    // ==========================================

    function showFieldError(el, message) {
        el.classList.add("input-error");
        showError(el, message);
    }

    function showError(el, msg) {
        // Check if error message already exists to avoid duplicates
        if (el.nextElementSibling?.classList.contains("error-message")) return;
        
        const d = document.createElement("div");
        d.className = "error-message";
        d.innerText = msg;
        d.style.color = "red"; // Ensure it's visible
        d.style.fontSize = "12px";
        el.insertAdjacentElement("afterend", d);
    }

    function clearValidation() {
        document.querySelectorAll(".input-error, .input-success")
            .forEach(el => el.classList.remove("input-error", "input-success"));

        document.querySelectorAll(".error-message").forEach(e => e.remove());
    }
    </script>

    </body>
</html>