<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title> Add Course Form</title>

  <link href="{{ url_for('static', path='/css/helper_add/common_form.css') }}" rel="stylesheet">

</head>
<body>
  <div class="form-container">

    <div id="header"> 
      <h1>Add Course Form</h1>
    </div>

    <form id="courseForm" action="/helper/add_course" method="POST" enctype="multipart/form-data">

      <section>
        <h3>Course Information</h3>

        <!-- First Row -->
        <div id="first-row">
          <div class="form-row">
            <label>Department:</label>
            <select name="department_id" id="department">
                <option value="">-Department-</option>
            </select>
          </div>

          <div class="form-row">
            <label>Course Name:</label>
            <input type="text" name="course_name">
          </div>
        </div>

      </section>

      <div class="submit-container">
        <button type="submit">Submit</button>
        <button type="button" onclick="window.location.href='/main/list_form'">Close</button>
      </div>
      
    </form>
  </div>

  <script>

        // Load departments for the dropdown
        async function loadSelection() {
            try {
                const response = await fetch("/helper/get_department");
                const data = await response.json();
                const select = document.getElementById("department");
                select.innerHTML = '<option value="">-Department-</option>';

                data.departments.forEach(dep => {
                    const option = document.createElement("option");
                    option.value = dep.id;
                    option.textContent = dep.department;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Failed to load departments", err);
            }
        }

        window.onload = loadSelection;

        // Form validation
        document.getElementById("courseForm").addEventListener("submit", function (e) {
            e.preventDefault(); // Stop standard submission to validate first
            clearValidation();

            let isValid = true;

            // 1. Validate Course Name
            const courseInput = document.querySelector("input[name='course_name']");
            if (courseInput.value.trim() === "") {
                showFieldError(courseInput, "Course Name is required");
                isValid = false;
            }

            // 2. Validate Department Dropdown
            const deptSelect = document.querySelector("select[name='department_id']");
            if (deptSelect.value === "") {
                showFieldError(deptSelect, "Department is required");
                isValid = false;
            }

            // 3. If everything is valid, submit the form
            if (isValid) {
                this.submit();
            }
        });

        // ==========================================
        //  HELPER FUNCTIONS
        // ==========================================
        function showFieldError(el, message) {
            el.classList.add("input-error");
            showError(el, message);
        }

        function showError(el, msg) {
            if (el.nextElementSibling?.classList.contains("error-message")) return;
            const d = document.createElement("div");
            d.className = "error-message";
            d.innerText = msg;
            d.style.color = "red";
            d.style.fontSize = "12px";
            el.insertAdjacentElement("afterend", d);
        }

        function clearValidation() {
            document.querySelectorAll(".input-error").forEach(el => el.classList.remove("input-error"));
            document.querySelectorAll(".error-message").forEach(e => e.remove());
        }

  </script>
</body>
</html>
